apiVersion: v1
kind: ConfigMap
metadata:
  name: tcp-ingress-config
  namespace: ghost
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;

    events {
        worker_connections 4096;
        use epoll;
        multi_accept on;
    }

    stream {
        log_format tcp_proxy '$remote_addr [$time_local] '
                             '$protocol $status $bytes_sent $bytes_received '
                             '$session_time "$upstream_addr"';

        access_log /var/log/nginx/tcp_access.log tcp_proxy;

        # HTTP - pyrosec.is:80 -> OpenResty
        upstream http_backend {
            server openresty:80;
        }
        server {
            listen 80;
            proxy_pass http_backend;
            proxy_timeout 60s;
            proxy_connect_timeout 10s;
        }

        # HTTPS - pyrosec.is:443 -> OpenResty (TLS pass-through)
        upstream https_backend {
            server openresty:443;
        }
        server {
            listen 443;
            proxy_pass https_backend;
            proxy_timeout 60s;
            proxy_connect_timeout 10s;
        }

        # OpenVPN - pyrosec.is:1194
        upstream openvpn_backend {
            server openvpn:1194;
        }
        server {
            listen 1194;
            proxy_pass openvpn_backend;
            proxy_timeout 600s;
            proxy_connect_timeout 10s;
        }

        # Tinyproxy (HTTP CONNECT proxy for OpenVPN) - pyrosec.is:8880
        upstream tinyproxy_backend {
            server openvpn:8880;
        }
        server {
            listen 8880;
            proxy_pass tinyproxy_backend;
            proxy_timeout 600s;
            proxy_connect_timeout 10s;
        }

        # XMPP Client - pyrosec.is:5222
        upstream xmpp_client_backend {
            server prosody:5222;
        }
        server {
            listen 5222;
            proxy_pass xmpp_client_backend;
            proxy_timeout 300s;
            proxy_connect_timeout 10s;
        }

        # XMPP Client TLS - pyrosec.is:5223
        upstream xmpp_client_tls_backend {
            server prosody:5223;
        }
        server {
            listen 5223;
            proxy_pass xmpp_client_tls_backend;
            proxy_timeout 300s;
            proxy_connect_timeout 10s;
        }

        # XMPP Server-to-Server - pyrosec.is:5269
        upstream xmpp_s2s_backend {
            server prosody:5269;
        }
        server {
            listen 5269;
            proxy_pass xmpp_s2s_backend;
            proxy_timeout 300s;
            proxy_connect_timeout 10s;
        }

        # Asterisk SIP - pyrosec.is:35061
        upstream asterisk_sip_backend {
            server asterisk:35061;
        }
        server {
            listen 35061;
            proxy_pass asterisk_sip_backend;
            proxy_timeout 300s;
            proxy_connect_timeout 10s;
        }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tcp-ingress
  namespace: ghost
  labels:
    app: tcp-ingress
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tcp-ingress
  template:
    metadata:
      labels:
        app: tcp-ingress
    spec:
      containers:
      - name: nginx
        image: nginx:1.25-alpine
        ports:
        - containerPort: 80
          name: http
        - containerPort: 443
          name: https
        - containerPort: 1194
          name: openvpn
        - containerPort: 8880
          name: tinyproxy
        - containerPort: 5222
          name: xmpp-client
        - containerPort: 5223
          name: xmpp-tls
        - containerPort: 5269
          name: xmpp-s2s
        - containerPort: 35061
          name: asterisk-sip
        volumeMounts:
        - name: config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 500m
            memory: 256Mi
        livenessProbe:
          tcpSocket:
            port: 5222
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          tcpSocket:
            port: 5222
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: tcp-ingress-config
---
apiVersion: v1
kind: Service
metadata:
  name: tcp-ingress
  namespace: ghost
  labels:
    app: tcp-ingress
spec:
  type: LoadBalancer
  selector:
    app: tcp-ingress
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    name: http
  - port: 443
    targetPort: 443
    protocol: TCP
    name: https
  - port: 1194
    targetPort: 1194
    protocol: TCP
    name: openvpn
  - port: 8880
    targetPort: 8880
    protocol: TCP
    name: tinyproxy
  - port: 5222
    targetPort: 5222
    protocol: TCP
    name: xmpp-client
  - port: 5223
    targetPort: 5223
    protocol: TCP
    name: xmpp-tls
  - port: 5269
    targetPort: 5269
    protocol: TCP
    name: xmpp-s2s
  - port: 35061
    targetPort: 35061
    protocol: TCP
    name: asterisk-sip
  externalTrafficPolicy: Cluster
